"use strict";(()=>{var e={};e.id=3002,e.ids=[3002],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},8678:e=>{e.exports=import("pg")},93827:(e,r,s)=>{s.a(e,async(e,o)=>{try{s.r(r),s.d(r,{originalPathname:()=>f,patchFetch:()=>u,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p});var t=s(73278),a=s(45002),l=s(54877),n=s(67248),i=e([n]);n=(i.then?(await i)():i)[0];let c=new t.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/auth/register/route",pathname:"/api/auth/register",filename:"route",bundlePath:"app/api/auth/register/route"},resolvedPagePath:"C:\\Users\\x4539\\Downloads\\Invest2025-main\\Invest2025-main\\app\\api\\auth\\register\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:g}=c,f="/api/auth/register/route";function u(){return(0,l.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}o()}catch(e){o(e)}})},67248:(e,r,s)=>{s.a(e,async(e,o)=>{try{s.r(r),s.d(r,{POST:()=>c});var t=s(71309),a=s(93981),l=s(67390),n=s.n(l),i=s(44819),u=e([i]);async function c(e){console.log("\uD83D\uDD35 Registration API called");try{let r=await e.json();console.log("\uD83D\uDCE6 Request body:",{email:r.email,fullName:r.fullName,country:r.country,referralCode:r.referralCode});let{email:s,password:o,fullName:l,country:u,referralCode:c}=r;if(!s||!o||!l)return console.log("❌ Validation failed: missing fields"),t.NextResponse.json({success:!1,error:"Все поля обязательны для заполнения",field:s?o?"full_name":"password":"email"},{status:400});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s))return t.NextResponse.json({success:!1,error:"Некорректный формат email",field:"email"},{status:400});if(o.length<6)return t.NextResponse.json({success:!1,error:"Пароль должен содержать минимум 6 символов",field:"password"},{status:400});console.log("\uD83D\uDD0C Connecting to database..."),console.log("\uD83D\uDCCD DATABASE_URL:",process.env.DATABASE_URL?.replace(/:[^:@]+@/,":****@")),console.log("✅ Database connected successfully!");{console.log("\uD83D\uDD0D Checking if user exists...");let e=await (0,i.I)("SELECT id FROM users WHERE email = $1",[s.toLowerCase()]);if(console.log("✅ User check complete:",e.rows.length>0?"User exists":"User not found"),e.rows.length>0)return t.NextResponse.json({success:!1,error:"Пользователь с таким email уже существует",field:"email"},{status:400});console.log("\uD83D\uDD10 Hashing password...");let r=await a.ZP.hash(o,10);console.log("✅ Password hashed");let d="REF"+Math.random().toString(36).substring(2,10).toUpperCase();console.log("\uD83C\uDFAB Generated referral code:",d);let p=null;c&&(console.log("\uD83D\uDD0D Checking referral code:",c),(await (0,i.I)("SELECT referral_code FROM users WHERE referral_code = $1",[c])).rows.length>0?(p=c,console.log("✅ Valid referral code found")):console.log("⚠️ Invalid referral code, ignoring")),console.log("\uD83D\uDCBE Creating user in database...");let g=(await (0,i.I)(`INSERT INTO users (
          email, 
          password_hash, 
          full_name, 
          country,
          referral_code,
          referred_by,
          balance,
          total_invested,
          total_earned,
          role_id,
          status,
          created_at
        ) VALUES ($1, $2, $3, $4, $5, $6, 0, 0, 0, 3, 'active', NOW())
        RETURNING id, email, full_name, role_id, referral_code, balance, created_at`,[s.toLowerCase(),r,l,u||null,d,p])).rows[0];console.log("✅ User created successfully:",g.id);let f=1===g.role_id?"super_admin":2===g.role_id?"admin":"user",m=n().sign({userId:g.id,email:g.email,role:f,isDemoMode:!1},process.env.NEXTAUTH_SECRET||process.env.JWT_SECRET||"fallback_secret",{expiresIn:"7d"});return console.log("\uD83C\uDF89 Registration successful!"),t.NextResponse.json({success:!0,message:"Регистрация успешна!",user:{id:g.id,email:g.email,fullName:g.full_name,full_name:g.full_name,role:f,referralCode:g.referral_code,balance:parseFloat(g.balance||0),createdAt:g.created_at},token:m,redirect:"/dashboard"})}}catch(e){if(console.error("❌ Registration error:",e),console.error("Error details:",{message:e.message,code:e.code,detail:e.detail}),"23505"===e.code)return t.NextResponse.json({success:!1,error:"Пользователь с таким email уже существует",field:"email"},{status:400});if("ECONNREFUSED"===e.code||e.message?.includes("connect"))return t.NextResponse.json({success:!1,error:"Ошибка подключения к базе данных. Проверьте, что PostgreSQL запущен."},{status:500});if("42703"===e.code)return t.NextResponse.json({success:!1,error:"Ошибка структуры базы данных. Запустите setup-registration.bat"},{status:500});return t.NextResponse.json({success:!1,error:`Ошибка при регистрации: ${e.message||"Попробуйте позже."}`},{status:500})}}i=(u.then?(await u)():u)[0],o()}catch(e){o(e)}})},44819:(e,r,s)=>{s.a(e,async(e,o)=>{try{s.d(r,{I:()=>l});var t=s(8678),a=e([t]);t=(a.then?(await a)():a)[0];let n=process.env.POSTGRES_URL_NON_POOLING||process.env.DATABASE_URL||process.env.POSTGRES_URL;if(!n)throw Error("DATABASE_URL, POSTGRES_URL, or POSTGRES_URL_NON_POOLING must be set. Did you forget to provision a database?");let i=new t.Pool({connectionString:n,ssl:!!n?.includes("sslmode=require")&&{rejectUnauthorized:!1}});async function l(e,r){let s=await i.connect();try{return await s.query(e,r)}finally{s.release()}}o()}catch(e){o(e)}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),o=r.X(0,[7787,4833,7390,3981],()=>s(93827));module.exports=o})();