"use strict";(()=>{var e={};e.id=2140,e.ids=[2140],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8678:e=>{e.exports=import("pg")},98830:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{originalPathname:()=>_,patchFetch:()=>u,requestAsyncStorage:()=>c,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>d});var s=a(73278),o=a(45002),n=a(54877),i=a(81323),l=e([i]);i=(l.then?(await l)():l)[0];let p=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/users/export/route",pathname:"/api/admin/users/export",filename:"route",bundlePath:"app/api/admin/users/export/route"},resolvedPagePath:"C:\\Users\\x4539\\Downloads\\Invest2025-main\\Invest2025-main\\app\\api\\admin\\users\\export\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:c,staticGenerationAsyncStorage:d,serverHooks:h}=p,_="/api/admin/users/export/route";function u(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:d})}r()}catch(e){r(e)}})},81323:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{GET:()=>i});var s=a(71309),o=a(64985),n=e([o]);async function i(e){try{let{searchParams:t}=new URL(e.url),a=t.get("search")||"",r=t.get("status")||"all",n=t.get("role")||"all",i=t.get("dateFrom"),l=t.get("dateTo");console.log("Exporting users with filters:",{search:a,status:r,role:n,dateFrom:i,dateTo:l});let u=[],p=[],c=1;a&&(u.push(`(email ILIKE $${c} OR full_name ILIKE $${c} OR id::text ILIKE $${c})`),p.push(`%${a}%`),c++),"all"!==r&&("active"===r?(u.push(`is_active = $${c}`),p.push(!0)):"inactive"===r&&(u.push(`is_active = $${c}`),p.push(!1)),c++),"all"!==n&&("admin"===n?(u.push(`role_id = $${c}`),p.push(1)):"user"===n&&(u.push(`role_id = $${c}`),p.push(2)),c++),i&&(u.push(`created_at >= $${c}`),p.push(new Date(i)),c++),l&&(u.push(`created_at <= $${c}`),p.push(new Date(l)),c++);let d=u.length>0?`WHERE ${u.join(" AND ")}`:"",h=await (0,o.I)(`
      SELECT 
        id, email, full_name, balance, total_invested, total_earned, 
        is_active, role_id, created_at, last_login
      FROM users 
      ${d}
      ORDER BY created_at DESC
    `,p),_=["ID,Email,Полное имя,Баланс,Всего инвестировано,Всего заработано,Статус,Роль,Дата регистрации,Последний вход"];h.rows.forEach(e=>{let t=[e.id,e.email,`"${e.full_name}"`,parseFloat(e.balance||0).toFixed(2),parseFloat(e.total_invested||0).toFixed(2),parseFloat(e.total_earned||0).toFixed(2),e.is_active?"Активен":"Неактивен",1===e.role_id?"Администратор":"Пользователь",new Date(e.created_at).toLocaleDateString("ru-RU"),e.last_login?new Date(e.last_login).toLocaleDateString("ru-RU"):"Никогда"];_.push(t.join(","))});let m=_.join("\n");return new s.NextResponse(m,{headers:{"Content-Type":"text/csv; charset=utf-8","Content-Disposition":`attachment; filename="users_export_${new Date().toISOString().split("T")[0]}.csv"`}})}catch(e){return console.error("Users export error:",e),s.NextResponse.json({error:"Ошибка экспорта пользователей"},{status:500})}}o=(n.then?(await n)():n)[0],r()}catch(e){r(e)}})},64985:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{I:()=>n,d:()=>l});var s=a(8678),o=e([s]);s=(o.then?(await o)():o)[0];let i=process.env.POSTGRES_URL_NON_POOLING||process.env.DATABASE_URL||process.env.POSTGRES_URL;if(!i)throw Error("DATABASE_URL, POSTGRES_URL, or POSTGRES_URL_NON_POOLING must be set. Did you forget to provision a database?");let l=new s.Pool({connectionString:i,ssl:!!i?.includes("sslmode=require")&&{rejectUnauthorized:!1}});async function n(e,t){let a=await l.connect();try{return await a.query(e,t)}finally{a.release()}}r()}catch(e){r(e)}})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[7787,4833],()=>a(98830));module.exports=r})();