"use strict";(()=>{var e={};e.id=6081,e.ids=[6081],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},8678:e=>{e.exports=import("pg")},82916:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>d,requestAsyncStorage:()=>c,routeModule:()=>l,serverHooks:()=>w,staticGenerationAsyncStorage:()=>p});var s=r(73278),n=r(45002),o=r(54877),i=r(95080),u=e([i]);i=(u.then?(await u)():u)[0];let l=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/withdrawal-requests/[id]/route",pathname:"/api/admin/withdrawal-requests/[id]",filename:"route",bundlePath:"app/api/admin/withdrawal-requests/[id]/route"},resolvedPagePath:"C:\\Users\\x4539\\Downloads\\Invest2025-main\\Invest2025-main\\app\\api\\admin\\withdrawal-requests\\[id]\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,serverHooks:w}=l,m="/api/admin/withdrawal-requests/[id]/route";function d(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:p})}a()}catch(e){a(e)}})},95080:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{PATCH:()=>d});var s=r(71309),n=r(64985),o=r(67390),i=r.n(o),u=e([n]);async function d(e,{params:t}){try{console.log("=== ADMIN UPDATE WITHDRAWAL REQUEST ===");let r=function(e){let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return null;let r=t.substring(7);try{let e=process.env.NEXTAUTH_SECRET||process.env.JWT_SECRET||"fallback_secret",t=i().verify(r,e);if("admin"!==t.role&&"super_admin"!==t.role)return null;return t}catch(e){return console.error("Admin token verification error:",e),null}}(e);if(!r)return s.NextResponse.json({error:"Доступ запрещен"},{status:403});let{status:a,admin_comment:o}=await e.json(),u=t.id;if(console.log("Request details:",{requestId:u,status:a,admin_comment:o,adminUserId:r.userId}),!u||!a)return s.NextResponse.json({error:"Не указаны обязательные поля"},{status:400});let d=["pending","approved","rejected"];if(!d.includes(a))return console.error("Invalid status:",a,"Allowed:",d),s.NextResponse.json({error:`Недопустимый статус: ${a}. Разрешены: ${d.join(", ")}`},{status:400});console.log("Updating withdrawal request:",u,"Status:",a);let l=await (0,n.I)("SELECT user_id, amount, final_amount FROM withdrawal_requests WHERE id = $1",[u]);if(0===l.rows.length)return s.NextResponse.json({error:"Заявка не найдена"},{status:404});let{user_id:c,amount:p,final_amount:w}=l.rows[0];await (0,n.I)("BEGIN");try{await (0,n.I)(`UPDATE withdrawal_requests 
         SET status = $1, admin_comment = $2, processed_at = NOW(), processed_by = $3
         WHERE id = $4`,[a,o||null,r.userId,u]),"rejected"===a?(await (0,n.I)("UPDATE users SET balance = balance + $1 WHERE id = $2",[p,c]),await (0,n.I)(`INSERT INTO transactions (id, user_id, type, amount, status, description, created_at)
           VALUES (gen_random_uuid(), $1, 'refund', $2, 'completed', 'Возврат средств (заявка на вывод отклонена)', NOW())`,[c,p]),console.log("✅ Withdrawal rejected and funds returned to balance")):"approved"===a&&(await (0,n.I)(`INSERT INTO transactions (id, user_id, type, amount, status, description, created_at)
           VALUES (gen_random_uuid(), $1, 'withdrawal', $2, 'completed', 'Вывод средств (одобрено администратором)', NOW())`,[c,w||p]),console.log("✅ Withdrawal approved")),await (0,n.I)("COMMIT")}catch(e){throw await (0,n.I)("ROLLBACK"),e}return console.log("✅ Withdrawal request updated successfully"),s.NextResponse.json({success:!0,message:"Заявка обновлена успешно"})}catch(e){return console.error("❌ Error updating withdrawal request:",e),s.NextResponse.json({error:"Ошибка обновления заявки",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}n=(u.then?(await u)():u)[0],a()}catch(e){a(e)}})},64985:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{I:()=>o,d:()=>u});var s=r(8678),n=e([s]);s=(n.then?(await n)():n)[0];let i=process.env.POSTGRES_URL_NON_POOLING||process.env.DATABASE_URL||process.env.POSTGRES_URL;if(!i)throw Error("DATABASE_URL, POSTGRES_URL, or POSTGRES_URL_NON_POOLING must be set. Did you forget to provision a database?");let u=new s.Pool({connectionString:i,ssl:!!i?.includes("sslmode=require")&&{rejectUnauthorized:!1}});async function o(e,t){let r=await u.connect();try{return await r.query(e,t)}finally{r.release()}}a()}catch(e){a(e)}})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[7787,4833,7390],()=>r(82916));module.exports=a})();