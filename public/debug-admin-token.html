<!DOCTYPE html>
<html>
<head>
    <title>–û—Ç–ª–∞–¥–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∞–¥–º–∏–Ω–∞</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; background: #f8f9fa; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç –û—Ç–ª–∞–¥–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
    
    <button onclick="checkToken()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
    <button onclick="loginAdmin()">–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω</button>
    <button onclick="testWithdrawalAPI()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API –≤—ã–≤–æ–¥–∞</button>
    <button onclick="clearStorage()">–û—á–∏—Å—Ç–∏—Ç—å localStorage</button>
    
    <div id="result"></div>

    <script>
        function addResult(message) {
            const div = document.createElement('div');
            div.className = 'result';
            div.innerHTML = message;
            document.getElementById('result').appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('result').innerHTML = '';
        }
        
        function checkToken() {
            clearResults();
            
            const authToken = localStorage.getItem('authToken');
            const userId = localStorage.getItem('userId');
            const adminAuth = localStorage.getItem('adminAuth');
            const adminUser = localStorage.getItem('adminUser');
            
            addResult(`
                <h3>üìã –î–∞–Ω–Ω—ã–µ –≤ localStorage:</h3>
                <strong>authToken:</strong> ${authToken ? authToken.substring(0, 50) + '...' : '–ù–ï–¢'}<br>
                <strong>userId:</strong> ${userId || '–ù–ï–¢'}<br>
                <strong>adminAuth:</strong> ${adminAuth || '–ù–ï–¢'}<br>
                <strong>adminUser:</strong> ${adminUser ? JSON.stringify(JSON.parse(adminUser), null, 2) : '–ù–ï–¢'}
            `);
        }
        
        async function loginAdmin() {
            clearResults();
            addResult('üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ö–æ–¥ –∞–¥–º–∏–Ω–∞...');
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@example.com',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.user.isAdmin) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                    localStorage.setItem("authToken", data.token);
                    localStorage.setItem("userId", data.user.id);
                    localStorage.setItem("adminAuth", "true");
                    localStorage.setItem("adminUser", JSON.stringify(data.user));
                    
                    addResult(`
                        <h3>‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –∞–¥–º–∏–Ω–∞!</h3>
                        <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${data.user.fullName}<br>
                        <strong>Email:</strong> ${data.user.email}<br>
                        <strong>–†–æ–ª—å:</strong> ${data.user.role}<br>
                        <strong>–ê–¥–º–∏–Ω:</strong> ${data.user.isAdmin}<br>
                        <strong>–¢–æ–∫–µ–Ω:</strong> ${data.token.substring(0, 50)}...
                    `);
                } else {
                    addResult(`‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${data.error || '–ù–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞'}`);
                }
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        async function testWithdrawalAPI() {
            clearResults();
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                addResult('‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞! –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ –∞–¥–º–∏–Ω.');
                return;
            }
            
            addResult('üîÑ –ü–æ–ª—É—á–∞–µ–º –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥...');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –∑–∞—è–≤–∫–∏
                const requestsResponse = await fetch('/api/admin/withdrawal-requests', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const requestsData = await requestsResponse.json();
                
                if (!requestsData.success) {
                    addResult(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞—è–≤–æ–∫: ${requestsData.error}`);
                    return;
                }
                
                addResult(`üìä –ù–∞–π–¥–µ–Ω–æ ${requestsData.requests.length} –∑–∞—è–≤–æ–∫`);
                
                // –ù–∞—Ö–æ–¥–∏–º pending –∑–∞—è–≤–∫—É
                const pendingRequest = requestsData.requests.find(req => req.status === 'pending');
                
                if (!pendingRequest) {
                    addResult('‚ùå –ù–µ—Ç –∑–∞—è–≤–æ–∫ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º pending –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                    return;
                }
                
                addResult(`üí∏ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞—è–≤–∫—É: ${pendingRequest.id.substring(0, 8)}... ($${pendingRequest.amount})`);
                
                // –ü—ã—Ç–∞–µ–º—Å—è –æ–¥–æ–±—Ä–∏—Ç—å
                const approveResponse = await fetch(`/api/admin/withdrawal-requests/${pendingRequest.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        status: 'approved',
                        admin_comment: '–¢–µ—Å—Ç –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞'
                    })
                });
                
                addResult(`üì• –û—Ç–≤–µ—Ç API: Status ${approveResponse.status}`);
                
                if (approveResponse.ok) {
                    const data = await approveResponse.json();
                    addResult(`‚úÖ –£—Å–ø–µ—Ö: ${data.message}`);
                } else {
                    const errorText = await approveResponse.text();
                    addResult(`‚ùå –û—à–∏–±–∫–∞: ${errorText}`);
                }
                
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        function clearStorage() {
            localStorage.clear();
            addResult('üóëÔ∏è localStorage –æ—á–∏—â–µ–Ω');
        }
    </script>
</body>
</html>