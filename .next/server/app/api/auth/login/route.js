"use strict";(()=>{var e={};e.id=8873,e.ids=[8873],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},8678:e=>{e.exports=import("pg")},16301:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{originalPathname:()=>h,patchFetch:()=>l,requestAsyncStorage:()=>d,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>c});var a=t(73278),o=t(45002),i=t(54877),n=t(66647),u=e([n]);n=(u.then?(await u)():u)[0];let p=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"C:\\Users\\x4539\\Downloads\\Invest2025-main\\Invest2025-main\\app\\api\\auth\\login\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:c,serverHooks:m}=p,h="/api/auth/login/route";function l(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:c})}s()}catch(e){s(e)}})},66647:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{POST:()=>p});var a=t(71309),o=t(93981),i=t(67390),n=t.n(i),u=t(64985),l=e([u]);async function p(e){try{let{email:r,password:t}=await e.json();if(!r||!t)return a.NextResponse.json({error:"Email и пароль обязательны"},{status:400});let s=await (0,u.I)(`
      SELECT 
        id,
        email,
        full_name,
        password_hash,
        role,
        status
      FROM users
      WHERE email = $1 AND status = 'active'
    `,[r]);if(0===s.rows.length)return a.NextResponse.json({success:!1,error:"Пользователь с таким email не найден",field:"email"},{status:401});let i=s.rows[0];if("active"!==i.status)return a.NextResponse.json({success:!1,error:"Аккаунт заблокирован или неактивен. Обратитесь к администратору.",field:"status"},{status:401});if(!await o.ZP.compare(t,i.password_hash))return a.NextResponse.json({success:!1,error:"Неверный пароль",field:"password"},{status:401});await (0,u.I)(`
      UPDATE users 
      SET last_login = NOW(), updated_at = NOW()
      WHERE id = $1
    `,[i.id]);let l=n().sign({userId:i.id,email:i.email,role:i.role||"user"},process.env.NEXTAUTH_SECRET||"fallback-secret",{expiresIn:"24h"}),p="/dashboard";p="admin"===i.role||"super_admin"===i.role?"/admin/dashboard":"/dashboard";let d=a.NextResponse.json({success:!0,message:"Вход выполнен успешно",user:{id:i.id,email:i.email,fullName:i.full_name,role:i.role||"user",isAdmin:"admin"===i.role||"super_admin"===i.role},token:l,redirect:p});return d.cookies.set("auth-token",l,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:86400}),d}catch(e){return console.error("Login error:",e),a.NextResponse.json({error:"Ошибка сервера при входе"},{status:500})}}u=(l.then?(await l)():l)[0],s()}catch(e){s(e)}})},64985:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.d(r,{I:()=>i,d:()=>u});var a=t(8678),o=e([a]);a=(o.then?(await o)():o)[0];let n=process.env.POSTGRES_URL_NON_POOLING||process.env.DATABASE_URL||process.env.POSTGRES_URL;if(!n)throw Error("DATABASE_URL, POSTGRES_URL, or POSTGRES_URL_NON_POOLING must be set. Did you forget to provision a database?");let u=new a.Pool({connectionString:n,ssl:!!n?.includes("sslmode=require")&&{rejectUnauthorized:!1}});async function i(e,r){let t=await u.connect();try{return await t.query(e,r)}finally{t.release()}}s()}catch(e){s(e)}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[7787,4833,7390,3981],()=>t(16301));module.exports=s})();