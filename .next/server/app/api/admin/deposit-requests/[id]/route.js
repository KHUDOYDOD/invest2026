"use strict";(()=>{var e={};e.id=4407,e.ids=[4407],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},8678:e=>{e.exports=import("pg")},51511:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>d,requestAsyncStorage:()=>c,routeModule:()=>l,serverHooks:()=>E,staticGenerationAsyncStorage:()=>p});var a=r(73278),o=r(45002),n=r(54877),i=r(90918),u=e([i]);i=(u.then?(await u)():u)[0];let l=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/deposit-requests/[id]/route",pathname:"/api/admin/deposit-requests/[id]",filename:"route",bundlePath:"app/api/admin/deposit-requests/[id]/route"},resolvedPagePath:"C:\\Users\\x4539\\Downloads\\Invest2025-main\\Invest2025-main\\app\\api\\admin\\deposit-requests\\[id]\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,serverHooks:E}=l,m="/api/admin/deposit-requests/[id]/route";function d(){return(0,n.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:p})}s()}catch(e){s(e)}})},90918:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{PATCH:()=>d});var a=r(71309),o=r(64985),n=r(67390),i=r.n(n),u=e([o]);async function d(e,{params:t}){try{console.log("=== ADMIN UPDATE DEPOSIT REQUEST ===");let r=function(e){let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return null;let r=t.substring(7);try{let e=process.env.NEXTAUTH_SECRET||process.env.JWT_SECRET||"fallback_secret",t=i().verify(r,e);if("admin"!==t.role&&"super_admin"!==t.role)return null;return t}catch(e){return console.error("Admin token verification error:",e),null}}(e);if(!r)return a.NextResponse.json({error:"Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½"},{status:403});let{status:s,admin_comment:n}=await e.json(),u=t.id;if(!u||!s)return a.NextResponse.json({error:"ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ"},{status:400});if(console.log("Updating deposit request:",u,"Status:",s),"approved"===s){let e=await (0,o.I)("SELECT user_id, amount FROM deposit_requests WHERE id = $1",[u]);if(0===e.rows.length)return a.NextResponse.json({error:"Ð—Ð°ÑÐ²ÐºÐ° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"},{status:404});let{user_id:t,amount:i}=e.rows[0];await (0,o.I)("BEGIN");try{await (0,o.I)(`UPDATE deposit_requests 
           SET status = $1, admin_comment = $2, processed_at = NOW(), processed_by = $3
           WHERE id = $4`,[s,n||null,r.userId,u]),await (0,o.I)("UPDATE users SET balance = balance + $1 WHERE id = $2",[i,t]),await (0,o.I)(`INSERT INTO transactions (id, user_id, type, amount, status, description, created_at)
           VALUES (gen_random_uuid(), $1, 'deposit', $2, 'completed', 'ÐŸÐ¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð±Ð°Ð»Ð°Ð½ÑÐ° (Ð¾Ð´Ð¾Ð±Ñ€ÐµÐ½Ð¾ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼)', NOW())`,[t,i]);let e=await (0,o.I)("SELECT referred_by FROM users WHERE id = $1",[t]);if(e.rows.length>0&&e.rows[0].referred_by){let t=e.rows[0].referred_by,r=.05*parseFloat(i);console.log(`ðŸ’° Processing referral commission: ${r} for code ${t}`);let s=await (0,o.I)("SELECT id FROM users WHERE referral_code = $1",[t]);if(s.rows.length>0){let e=s.rows[0].id;await (0,o.I)("UPDATE users SET balance = balance + $1, total_earned = total_earned + $1 WHERE id = $2",[r,e]),await (0,o.I)(`INSERT INTO transactions (id, user_id, type, amount, status, description, created_at)
               VALUES (gen_random_uuid(), $1, 'referral_bonus', $2, 'completed', 'Ð ÐµÑ„ÐµÑ€Ð°Ð»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð¼Ð¸ÑÑÐ¸Ñ (5% Ð¾Ñ‚ Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð°)', NOW())`,[e,r]),console.log(`âœ… Referral commission ${r} credited to user ${e}`)}}await (0,o.I)("COMMIT"),console.log("âœ… Deposit request approved and balance updated")}catch(e){throw await (0,o.I)("ROLLBACK"),e}}else{let e=await (0,o.I)(`UPDATE deposit_requests 
         SET status = $1, admin_comment = $2, processed_at = NOW(), processed_by = $3
         WHERE id = $4
         RETURNING *`,[s,n||null,r.userId,u]);if(0===e.rows.length)return a.NextResponse.json({error:"Ð—Ð°ÑÐ²ÐºÐ° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"},{status:404})}return console.log("âœ… Deposit request updated successfully"),a.NextResponse.json({success:!0,message:"Ð—Ð°ÑÐ²ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"})}catch(e){return console.error("âŒ Error updating deposit request:",e),a.NextResponse.json({error:"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°ÑÐ²ÐºÐ¸",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}o=(u.then?(await u)():u)[0],s()}catch(e){s(e)}})},64985:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.d(t,{I:()=>n,d:()=>u});var a=r(8678),o=e([a]);a=(o.then?(await o)():o)[0];let i=process.env.POSTGRES_URL_NON_POOLING||process.env.DATABASE_URL||process.env.POSTGRES_URL;if(!i)throw Error("DATABASE_URL, POSTGRES_URL, or POSTGRES_URL_NON_POOLING must be set. Did you forget to provision a database?");let u=new a.Pool({connectionString:i,ssl:!!i?.includes("sslmode=require")&&{rejectUnauthorized:!1}});async function n(e,t){let r=await u.connect();try{return await r.query(e,t)}finally{r.release()}}s()}catch(e){s(e)}})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[7787,4833,7390],()=>r(51511));module.exports=s})();