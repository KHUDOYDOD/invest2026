"use strict";(()=>{var e={};e.id=5740,e.ids=[5740],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},8678:e=>{e.exports=import("pg")},72652:(e,s,r)=>{r.a(e,async(e,o)=>{try{r.r(s),r.d(s,{originalPathname:()=>f,patchFetch:()=>u,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>p,staticGenerationAsyncStorage:()=>m});var a=r(73278),t=r(45002),n=r(54877),i=r(58106),l=e([i]);i=(l.then?(await l)():l)[0];let c=new a.AppRouteRouteModule({definition:{kind:t.x.APP_ROUTE,page:"/api/login/route",pathname:"/api/login",filename:"route",bundlePath:"app/api/login/route"},resolvedPagePath:"C:\\Users\\x4539\\Downloads\\Invest2025-main\\Invest2025-main\\app\\api\\login\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:p}=c,f="/api/login/route";function u(){return(0,n.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:m})}o()}catch(e){o(e)}})},58106:(e,s,r)=>{r.a(e,async(e,o)=>{try{r.r(s),r.d(s,{POST:()=>c});var a=r(71309),t=r(93981),n=r(67390),i=r.n(n),l=r(64985),u=e([l]);l=(u.then?(await u)():u)[0];let d=[{id:"demo-admin-1",email:"admin@demo.com",password:"admin123",full_name:"Администратор Демо",role:"admin",balance:5e4},{id:"demo-user-1",email:"user@demo.com",password:"user123",full_name:"Пользователь Демо",role:"user",balance:1e4},{id:"demo-creator-1",email:"creator@investpro.com",password:"SuperAdmin2025!",full_name:"Создатель Системы",role:"super_admin",balance:0}];async function c(e){try{let{email:s,password:r}=await e.json();if(!s||!r)return a.NextResponse.json({success:!1,error:"Email и пароль обязательны"},{status:400});console.log("Attempting login for:",s);let o=null,n="user",u=!1;try{let e=await (0,l.I)("SELECT id, full_name, email, password_hash, role_id, balance, status FROM users WHERE LOWER(email) = LOWER($1)",[s]);if(0===e.rows.length)return console.log("User not found in database:",s),a.NextResponse.json({success:!1,error:"Неверный email или пароль"},{status:401});if(o=e.rows[0],"active"!==o.status)return console.log("Account is inactive:",s),a.NextResponse.json({success:!1,error:"Аккаунт деактивирован. Обратитесь в поддержку."},{status:403});if(console.log("Found user in database:",o.email,"Role ID:",o.role_id),!await t.ZP.compare(r,o.password_hash))return console.log("Invalid password for user:",s),a.NextResponse.json({success:!1,error:"Неверный email или пароль"},{status:401});n=1===o.role_id?"super_admin":2===o.role_id?"admin":"user",await (0,l.I)("UPDATE users SET last_login = NOW() WHERE id = $1",[o.id])}catch(t){console.log("⚠️  Database unavailable, using DEMO mode"),console.log("Database error:",t.message),u=!0;let e=d.find(e=>e.email.toLowerCase()===s.toLowerCase());if(!e)return console.log("Demo user not found:",s),a.NextResponse.json({success:!1,error:"Неверный email или пароль"},{status:401});if(r!==e.password)return console.log("Invalid demo password for user:",s),a.NextResponse.json({success:!1,error:"Неверный email или пароль"},{status:401});o={id:e.id,full_name:e.full_name,email:e.email,balance:e.balance},n=e.role,console.log("✅ Demo login successful for:",e.email,"Role:",n)}let c=i().sign({userId:o.id,email:o.email,role:n,isDemoMode:u},process.env.NEXTAUTH_SECRET||process.env.JWT_SECRET||"fallback_secret",{expiresIn:"7d"});console.log("✅ Successful login for:",o.email,"Role:",n,u?"(DEMO MODE)":"");let m="/dashboard";return("super_admin"===n||"admin"===n)&&(m="/admin/dashboard"),a.NextResponse.json({success:!0,message:u?"Успешная авторизация (ДЕМО-РЕЖИМ)":"Успешная авторизация",token:c,redirect:m,isDemoMode:u,user:{id:o.id,fullName:o.full_name,email:o.email,role:n,balance:o.balance,isAdmin:"super_admin"===n||"admin"===n}})}catch(e){return console.error("Login error:",e),a.NextResponse.json({success:!1,error:"Ошибка сервера"},{status:500})}}o()}catch(e){o(e)}})},64985:(e,s,r)=>{r.a(e,async(e,o)=>{try{r.d(s,{I:()=>n,d:()=>l});var a=r(8678),t=e([a]);a=(t.then?(await t)():t)[0];let i=process.env.POSTGRES_URL_NON_POOLING||process.env.DATABASE_URL||process.env.POSTGRES_URL;if(!i)throw Error("DATABASE_URL, POSTGRES_URL, or POSTGRES_URL_NON_POOLING must be set. Did you forget to provision a database?");let l=new a.Pool({connectionString:i,ssl:!!i?.includes("sslmode=require")&&{rejectUnauthorized:!1}});async function n(e,s){let r=await l.connect();try{return await r.query(e,s)}finally{r.release()}}o()}catch(e){o(e)}})}};var s=require("../../../webpack-runtime.js");s.C(e);var r=e=>s(s.s=e),o=s.X(0,[7787,4833,7390,3981],()=>r(72652));module.exports=o})();