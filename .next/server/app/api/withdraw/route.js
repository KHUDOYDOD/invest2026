"use strict";(()=>{var e={};e.id=5886,e.ids=[5886],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},8678:e=>{e.exports=import("pg")},49712:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{originalPathname:()=>h,patchFetch:()=>c,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>w,staticGenerationAsyncStorage:()=>p});var a=t(73278),n=t(45002),o=t(54877),u=t(28365),i=e([u]);u=(i.then?(await i)():i)[0];let l=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/withdraw/route",pathname:"/api/withdraw",filename:"route",bundlePath:"app/api/withdraw/route"},resolvedPagePath:"C:\\Users\\x4539\\Downloads\\Invest2025-main\\Invest2025-main\\app\\api\\withdraw\\route.ts",nextConfigOutput:"",userland:u}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:w}=l,h="/api/withdraw/route";function c(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:p})}s()}catch(e){s(e)}})},28365:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{POST:()=>c});var a=t(71309),n=t(64985),o=t(67390),u=t.n(o),i=e([n]);async function c(e){try{console.log("=== СОЗДАНИЕ ЗАЯВКИ НА ВЫВОД ===");let r=function(e){let r=e.headers.get("authorization");if(!r||!r.startsWith("Bearer "))return null;let t=r.substring(7);try{let e=process.env.NEXTAUTH_SECRET||process.env.JWT_SECRET||"fallback_secret";return u().verify(t,e)}catch(e){return console.error("Token verification error:",e),null}}(e);if(!r)return a.NextResponse.json({success:!1,error:"Необходима авторизация. Пожалуйста, войдите в систему."},{status:401});let{amount:t,payment_method:s,wallet_address:o,card_number:i,card_holder_name:c,phone_number:l,account_holder_name:d,crypto_network:p}=await e.json();if(console.log("Данные запроса:",{amount:t,payment_method:s,wallet_address:o,card_number:i,card_holder_name:c,phone_number:l,account_holder_name:d,crypto_network:p}),!t)return a.NextResponse.json({success:!1,error:"Укажите сумму для вывода"},{status:400});let w=parseFloat(t);if(isNaN(w)||w<=0)return a.NextResponse.json({success:!1,error:"Сумма должна быть положительным числом"},{status:400});if(w<10)return a.NextResponse.json({success:!1,error:"Минимальная сумма для вывода: $10"},{status:400});if(!s)return a.NextResponse.json({success:!1,error:"Выберите способ вывода средств"},{status:400});if(!["card","crypto","sbp","bank"].includes(s))return a.NextResponse.json({success:!1,error:"Недопустимый способ вывода"},{status:400});if("crypto"===s&&!o)return a.NextResponse.json({success:!1,error:"Укажите адрес криптокошелька"},{status:400});if("card"===s&&!i)return a.NextResponse.json({success:!1,error:"Укажите номер карты"},{status:400});console.log("Creating withdrawal request:",{userId:r.userId,amount:w,method:s});let h=await (0,n.I)("SELECT balance, full_name FROM users WHERE id = $1",[r.userId]);if(0===h.rows.length)return a.NextResponse.json({success:!1,error:"Пользователь не найден в системе"},{status:404});let R=parseFloat(h.rows[0].balance),m=h.rows[0].full_name;if(console.log(`Баланс пользователя ${m}: $${R}, запрашивает: $${w}`),0===R)return a.NextResponse.json({success:!1,error:"На вашем счету недостаточно средств для вывода",details:{currentBalance:R,requestedAmount:w,message:"Ваш текущий баланс: $0.00. Пополните счет или получите прибыль от инвестиций для вывода средств."}},{status:400});if(R<w){let e=w-R;return a.NextResponse.json({success:!1,error:`Недостаточно средств на счету`,details:{currentBalance:R,requestedAmount:w,shortage:e,message:`Ваш баланс: $${R.toFixed(2)}. Для вывода $${w.toFixed(2)} не хватает $${e.toFixed(2)}.`}},{status:400})}let _=.02*w,f=w-_;await (0,n.I)("BEGIN");try{await (0,n.I)("UPDATE users SET balance = balance - $1 WHERE id = $2",[w,r.userId]);let e=await (0,n.I)(`INSERT INTO withdrawal_requests (
          user_id, amount, method, wallet_address, card_number, card_holder_name,
          phone_number, account_holder_name, crypto_network, fee, final_amount, status, created_at
        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, 'pending', NOW()) 
        RETURNING id, created_at`,[r.userId,w,s,o||null,i||null,c||null,l||null,d||null,p||null,_,f]),t=await (0,n.I)(`INSERT INTO transactions (
          id, user_id, type, amount, status, description, created_at
        ) VALUES (gen_random_uuid(), $1, 'withdrawal', $2, 'pending', 'Заявка на вывод средств', NOW())
        RETURNING id`,[r.userId,w]);return await (0,n.I)("COMMIT"),console.log("✅ Withdrawal request created successfully"),a.NextResponse.json({success:!0,message:"Заявка на вывод создана успешно",transaction:{id:t.rows[0].id,amount:w,fee:_,final_amount:f,status:"pending",created_at:e.rows[0].created_at},withdrawal_request:{id:e.rows[0].id,status:"pending"}})}catch(e){throw await (0,n.I)("ROLLBACK"),e}}catch(e){return console.error("❌ Error creating withdrawal request:",e),a.NextResponse.json({success:!1,error:"Произошла ошибка при создании заявки на вывод",details:e instanceof Error?e.message:"Неизвестная ошибка"},{status:500})}}n=(i.then?(await i)():i)[0],s()}catch(e){s(e)}})},64985:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.d(r,{I:()=>o,d:()=>i});var a=t(8678),n=e([a]);a=(n.then?(await n)():n)[0];let u=process.env.POSTGRES_URL_NON_POOLING||process.env.DATABASE_URL||process.env.POSTGRES_URL;if(!u)throw Error("DATABASE_URL, POSTGRES_URL, or POSTGRES_URL_NON_POOLING must be set. Did you forget to provision a database?");let i=new a.Pool({connectionString:u,ssl:!!u?.includes("sslmode=require")&&{rejectUnauthorized:!1}});async function o(e,r){let t=await i.connect();try{return await t.query(e,r)}finally{t.release()}}s()}catch(e){s(e)}})}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[7787,4833,7390],()=>t(49712));module.exports=s})();