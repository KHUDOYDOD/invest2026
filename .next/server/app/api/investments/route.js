"use strict";(()=>{var e={};e.id=4094,e.ids=[4094],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},8678:e=>{e.exports=import("pg")},60476:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>c,requestAsyncStorage:()=>l,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>d});var a=r(73278),n=r(45002),o=r(54877),i=r(99153),u=e([i]);i=(u.then?(await u)():u)[0];let p=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/investments/route",pathname:"/api/investments",filename:"route",bundlePath:"app/api/investments/route"},resolvedPagePath:"C:\\Users\\x4539\\Downloads\\Invest2025-main\\Invest2025-main\\app\\api\\investments\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:l,staticGenerationAsyncStorage:d,serverHooks:m}=p,R="/api/investments/route";function c(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:d})}s()}catch(e){s(e)}})},99153:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{POST:()=>c});var a=r(71309),n=r(64985),o=r(67390),i=r.n(o),u=e([n]);async function c(e){try{let t;let r=e.headers.get("authorization"),s=null;if(r&&r.startsWith("Bearer ")&&(s=r.substring(7)),!s)return a.NextResponse.json({error:"Токен не предоставлен"},{status:401});try{t=i().verify(s,process.env.NEXTAUTH_SECRET||"fallback-secret")}catch(e){return a.NextResponse.json({error:"Недействительный токен"},{status:401})}let{plan_id:o,amount:u}=await e.json();if(!o||!u||u<=0)return a.NextResponse.json({error:"Неверные данные для инвестирования"},{status:400});console.log("Creating investment for user:",t.userId,"plan:",o,"amount:",u);let c=await (0,n.I)("SELECT * FROM investment_plans WHERE id = $1 AND is_active = true",[o]);if(0===c.rows.length)return a.NextResponse.json({error:"План инвестирования не найден"},{status:404});let p=c.rows[0];if(u<p.min_amount)return a.NextResponse.json({error:`Минимальная сумма инвестирования: $${p.min_amount}`},{status:400});if(p.max_amount&&u>p.max_amount)return a.NextResponse.json({error:`Максимальная сумма инвестирования: $${p.max_amount}`},{status:400});let l=await (0,n.I)("SELECT balance FROM users WHERE id = $1",[t.userId]);if(parseFloat(l.rows[0]?.balance||"0")<u)return a.NextResponse.json({error:"Недостаточно средств на балансе"},{status:400});await (0,n.I)("BEGIN");try{let e=await (0,n.I)(`INSERT INTO investments (user_id, plan_id, amount, status, total_profit, daily_profit, start_date, end_date, created_at)
         VALUES ($1, $2, $3, 'active', 0, 0, CURRENT_TIMESTAMP, $4, CURRENT_TIMESTAMP)
         RETURNING *`,[t.userId,o,u,new Date(Date.now()+864e5*p.duration_days)]);return await (0,n.I)(`INSERT INTO transactions (user_id, type, amount, status, description, payment_method, created_at)
         VALUES ($1, 'investment', $2, 'completed', $3, 'balance', CURRENT_TIMESTAMP)`,[t.userId,u,`Инвестирование в план "${p.name}"`]),await (0,n.I)("UPDATE users SET balance = balance - $1, total_invested = total_invested + $1 WHERE id = $2",[u,t.userId]),await (0,n.I)("COMMIT"),console.log("Investment created successfully:",e.rows[0]),a.NextResponse.json({success:!0,investment:e.rows[0],message:"Инвестиция успешно создана",voiceData:{amount:u,planName:p.name}})}catch(e){throw await (0,n.I)("ROLLBACK"),e}}catch(e){return console.error("Error creating investment:",e),a.NextResponse.json({error:"Ошибка создания инвестиции"},{status:500})}}n=(u.then?(await u)():u)[0],s()}catch(e){s(e)}})},64985:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.d(t,{I:()=>o,d:()=>u});var a=r(8678),n=e([a]);a=(n.then?(await n)():n)[0];let i=process.env.POSTGRES_URL_NON_POOLING||process.env.DATABASE_URL||process.env.POSTGRES_URL;if(!i)throw Error("DATABASE_URL, POSTGRES_URL, or POSTGRES_URL_NON_POOLING must be set. Did you forget to provision a database?");let u=new a.Pool({connectionString:i,ssl:!!i?.includes("sslmode=require")&&{rejectUnauthorized:!1}});async function o(e,t){let r=await u.connect();try{return await r.query(e,t)}finally{r.release()}}s()}catch(e){s(e)}})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[7787,4833,7390],()=>r(60476));module.exports=s})();