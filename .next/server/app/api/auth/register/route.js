"use strict";(()=>{var e={};e.id=3002,e.ids=[3002],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},74025:(e,r,s)=>{s.r(r),s.d(r,{originalPathname:()=>D,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>f});var o={};s.r(o),s.d(o,{POST:()=>d});var t=s(73278),a=s(45002),l=s(54877),n=s(71309),i=s(93981),u=s(67390),c=s.n(u);async function d(e){console.log("\uD83D\uDD35 Registration API called");try{let r=await e.json();console.log("\uD83D\uDCE6 Request body:",{email:r.email,fullName:r.fullName,country:r.country,referralCode:r.referralCode});let{email:s,password:o,fullName:t,country:a,referralCode:l}=r;if(!s||!o||!t)return console.log("❌ Validation failed: missing fields"),n.NextResponse.json({success:!1,error:"Все поля обязательны для заполнения",field:s?o?"full_name":"password":"email"},{status:400});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s))return n.NextResponse.json({success:!1,error:"Некорректный формат email",field:"email"},{status:400});if(o.length<6)return n.NextResponse.json({success:!1,error:"Пароль должен содержать минимум 6 символов",field:"password"},{status:400});console.log("\uD83D\uDD0C Connecting to database..."),console.log("\uD83D\uDCCD DATABASE_URL:",process.env.DATABASE_URL?.replace(/:[^:@]+@/,":****@")),console.log("✅ Database connected successfully!");{console.log("\uD83D\uDD0D Checking if user exists...");let e=await client.query("SELECT id FROM users WHERE email = $1",[s.toLowerCase()]);if(console.log("✅ User check complete:",e.rows.length>0?"User exists":"User not found"),e.rows.length>0)return n.NextResponse.json({success:!1,error:"Пользователь с таким email уже существует",field:"email"},{status:400});console.log("\uD83D\uDD10 Hashing password...");let r=await i.ZP.hash(o,10);console.log("✅ Password hashed");let u="REF"+Math.random().toString(36).substring(2,10).toUpperCase();console.log("\uD83C\uDFAB Generated referral code:",u);let d=null;l&&(console.log("\uD83D\uDD0D Checking referral code:",l),(await client.query("SELECT referral_code FROM users WHERE referral_code = $1",[l])).rows.length>0?(d=l,console.log("✅ Valid referral code found")):console.log("⚠️ Invalid referral code, ignoring")),console.log("\uD83D\uDCBE Creating user in database...");let p=(await client.query(`INSERT INTO users (
          email, 
          password_hash, 
          full_name, 
          country,
          referral_code,
          referred_by,
          balance,
          total_invested,
          total_earned,
          role_id,
          status,
          created_at
        ) VALUES ($1, $2, $3, $4, $5, $6, 0, 0, 0, 3, 'active', NOW())
        RETURNING id, email, full_name, role_id, referral_code, balance, created_at`,[s.toLowerCase(),r,t,a||null,u,d])).rows[0];console.log("✅ User created successfully:",p.id);let g=1===p.role_id?"super_admin":2===p.role_id?"admin":"user",f=c().sign({userId:p.id,email:p.email,role:g,isDemoMode:!1},process.env.NEXTAUTH_SECRET||process.env.JWT_SECRET||"fallback_secret",{expiresIn:"7d"});return console.log("\uD83C\uDF89 Registration successful!"),n.NextResponse.json({success:!0,message:"Регистрация успешна!",user:{id:p.id,email:p.email,fullName:p.full_name,full_name:p.full_name,role:g,referralCode:p.referral_code,balance:parseFloat(p.balance||0),createdAt:p.created_at},token:f,redirect:"/dashboard"})}}catch(e){if(console.error("❌ Registration error:",e),console.error("Error details:",{message:e.message,code:e.code,detail:e.detail}),"23505"===e.code)return n.NextResponse.json({success:!1,error:"Пользователь с таким email уже существует",field:"email"},{status:400});if("ECONNREFUSED"===e.code||e.message?.includes("connect"))return n.NextResponse.json({success:!1,error:"Ошибка подключения к базе данных. Проверьте, что PostgreSQL запущен."},{status:500});if("42703"===e.code)return n.NextResponse.json({success:!1,error:"Ошибка структуры базы данных. Запустите setup-registration.bat"},{status:500});return n.NextResponse.json({success:!1,error:`Ошибка при регистрации: ${e.message||"Попробуйте позже."}`},{status:500})}}let p=new t.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/auth/register/route",pathname:"/api/auth/register",filename:"route",bundlePath:"app/api/auth/register/route"},resolvedPagePath:"C:\\Users\\x4539\\Downloads\\Invest2025-main\\Invest2025-main\\app\\api\\auth\\register\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:m}=p,D="/api/auth/register/route";function h(){return(0,l.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:f})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),o=r.X(0,[7787,4833,7390,3981],()=>s(74025));module.exports=o})();