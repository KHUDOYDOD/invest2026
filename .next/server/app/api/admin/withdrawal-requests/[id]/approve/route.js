"use strict";(()=>{var e={};e.id=228,e.ids=[228],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},8678:e=>{e.exports=import("pg")},444:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{originalPathname:()=>E,patchFetch:()=>p,requestAsyncStorage:()=>c,routeModule:()=>d,serverHooks:()=>w,staticGenerationAsyncStorage:()=>l});var a=t(73278),o=t(45002),n=t(54877),i=t(75688),u=e([i]);i=(u.then?(await u)():u)[0];let d=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/withdrawal-requests/[id]/approve/route",pathname:"/api/admin/withdrawal-requests/[id]/approve",filename:"route",bundlePath:"app/api/admin/withdrawal-requests/[id]/approve/route"},resolvedPagePath:"C:\\Users\\x4539\\Downloads\\Invest2025-main\\Invest2025-main\\app\\api\\admin\\withdrawal-requests\\[id]\\approve\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:c,staticGenerationAsyncStorage:l,serverHooks:w}=d,E="/api/admin/withdrawal-requests/[id]/approve/route";function p(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:l})}s()}catch(e){s(e)}})},75688:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{POST:()=>p});var a=t(71309),o=t(67390),n=t.n(o),i=t(44819),u=e([i]);async function p(e,{params:r}){try{let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return a.NextResponse.json({error:"Unauthorized"},{status:401});let s=t.substring(7),o=n().verify(s,process.env.JWT_SECRET||"your-secret-key"),u=await (0,i.I)("SELECT role_id FROM users WHERE id = $1",[o.userId]);if(!u.rows[0]||1!==u.rows[0].role_id)return a.NextResponse.json({error:"Access denied"},{status:403});let{admin_comment:p}=await e.json(),d=r.id;if("3"===d||"4"===d)return a.NextResponse.json({success:!0,message:"Заявка одобрена (демо-режим)"});let c=await (0,i.I)("SELECT user_id, amount FROM withdrawal_requests WHERE id = $1",[d]);if(!c.rows[0])return a.NextResponse.json({error:"Заявка не найдена"},{status:404});let{user_id:l,amount:w}=c.rows[0],E=await (0,i.I)("SELECT balance FROM users WHERE id = $1",[l]);if(!E.rows[0]||parseFloat(E.rows[0].balance)<parseFloat(w))return a.NextResponse.json({error:"Недостаточно средств на балансе пользователя"},{status:400});let R=await (0,i.I)(`UPDATE withdrawal_requests 
       SET status = 'approved', 
           admin_comment = $1, 
           processed_at = NOW(),
           processed_by = $2
       WHERE id = $3`,[p||"Одобрено",o.userId,d]);if(0===R.rowCount)return a.NextResponse.json({error:"Заявка не найдена"},{status:404});return await (0,i.I)("UPDATE users SET balance = balance - $1 WHERE id = $2",[w,l]),a.NextResponse.json({success:!0,message:"Заявка на вывод одобрена"})}catch(e){return console.error("Error approving withdrawal request:",e),a.NextResponse.json({error:"Internal server error"},{status:500})}}i=(u.then?(await u)():u)[0],s()}catch(e){s(e)}})},44819:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.d(r,{I:()=>n});var a=t(8678),o=e([a]);a=(o.then?(await o)():o)[0];let i=process.env.POSTGRES_URL_NON_POOLING||process.env.DATABASE_URL||process.env.POSTGRES_URL;if(!i)throw Error("DATABASE_URL, POSTGRES_URL, or POSTGRES_URL_NON_POOLING must be set. Did you forget to provision a database?");let u=new a.Pool({connectionString:i,ssl:!!i?.includes("sslmode=require")&&{rejectUnauthorized:!1}});async function n(e,r){let t=await u.connect();try{return await t.query(e,r)}finally{t.release()}}s()}catch(e){s(e)}})}};var r=require("../../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[7787,4833,7390],()=>t(444));module.exports=s})();