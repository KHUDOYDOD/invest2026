"use strict";(()=>{var t={};t.id=7685,t.ids=[7685],t.modules={20399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8678:t=>{t.exports=import("pg")},5366:(t,e,a)=>{a.a(t,async(t,r)=>{try{a.r(e),a.d(e,{originalPathname:()=>m,patchFetch:()=>p,requestAsyncStorage:()=>l,routeModule:()=>c,serverHooks:()=>h,staticGenerationAsyncStorage:()=>d});var s=a(73278),n=a(45002),o=a(54877),i=a(80612),u=t([i]);i=(u.then?(await u)():u)[0];let c=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/transactions/export/route",pathname:"/api/admin/transactions/export",filename:"route",bundlePath:"app/api/admin/transactions/export/route"},resolvedPagePath:"C:\\Users\\x4539\\Downloads\\Invest2025-main\\Invest2025-main\\app\\api\\admin\\transactions\\export\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:l,staticGenerationAsyncStorage:d,serverHooks:h}=c,m="/api/admin/transactions/export/route";function p(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:d})}r()}catch(t){r(t)}})},80612:(t,e,a)=>{a.a(t,async(t,r)=>{try{a.r(e),a.d(e,{GET:()=>i});var s=a(71309),n=a(64985),o=t([n]);async function i(t){try{let{searchParams:e}=new URL(t.url),a=e.get("search")||"",r=e.get("transactionType")||"all",o=e.get("status")||"all",i=e.get("amountMin"),u=e.get("amountMax"),p=e.get("dateFrom"),c=e.get("dateTo");console.log("Exporting transactions with filters:",{search:a,type:r,status:o,amountMin:i,amountMax:u,dateFrom:p,dateTo:c});let l=[],d=[],h=1;a&&(l.push(`(u.email ILIKE $${h} OR u.full_name ILIKE $${h} OR t.description ILIKE $${h} OR t.id::text ILIKE $${h})`),d.push(`%${a}%`),h++),"all"!==r&&(l.push(`t.type = $${h}`),d.push(r),h++),"all"!==o&&(l.push(`t.status = $${h}`),d.push(o),h++),i&&!isNaN(parseFloat(i))&&(l.push(`t.amount >= $${h}`),d.push(parseFloat(i)),h++),u&&!isNaN(parseFloat(u))&&(l.push(`t.amount <= $${h}`),d.push(parseFloat(u)),h++),p&&(l.push(`t.created_at >= $${h}`),d.push(new Date(p)),h++),c&&(l.push(`t.created_at <= $${h}`),d.push(new Date(c)),h++);let m=l.length>0?`WHERE ${l.join(" AND ")}`:"",_=await (0,n.I)(`
      SELECT 
        t.id, t.user_id, t.type, t.amount, t.status, t.description, 
        t.method, t.fee, t.final_amount, t.created_at, t.updated_at,
        u.email as user_email, u.full_name as user_name
      FROM transactions t
      JOIN users u ON t.user_id = u.id
      ${m}
      ORDER BY t.created_at DESC
    `,d),x=["ID транзакции,Email пользователя,Имя пользователя,Тип,Сумма,Комиссия,Итоговая сумма,Статус,Описание,Метод,Дата создания,Дата обновления"],$=t=>{switch(t){case"deposit":return"Пополнение";case"withdrawal":return"Вывод";case"investment":return"Инвестиция";case"profit":return"Прибыль";case"referral":return"Реферал";default:return t}},w=t=>{switch(t.toLowerCase()){case"completed":return"Завершено";case"pending":return"В ожидании";case"failed":return"Ошибка";default:return t}};_.rows.forEach(t=>{let e=[t.id,t.user_email,`"${t.user_name}"`,$(t.type),parseFloat(t.amount||0).toFixed(2),parseFloat(t.fee||0).toFixed(2),parseFloat(t.final_amount||0).toFixed(2),w(t.status),`"${t.description||""}"`,`"${t.method||""}"`,new Date(t.created_at).toLocaleString("ru-RU"),t.updated_at?new Date(t.updated_at).toLocaleString("ru-RU"):""];x.push(e.join(","))});let R=x.join("\n");return new s.NextResponse(R,{headers:{"Content-Type":"text/csv; charset=utf-8","Content-Disposition":`attachment; filename="transactions_export_${new Date().toISOString().split("T")[0]}.csv"`}})}catch(t){return console.error("Transactions export error:",t),s.NextResponse.json({error:"Ошибка экспорта транзакций"},{status:500})}}n=(o.then?(await o)():o)[0],r()}catch(t){r(t)}})},64985:(t,e,a)=>{a.a(t,async(t,r)=>{try{a.d(e,{I:()=>o,d:()=>u});var s=a(8678),n=t([s]);s=(n.then?(await n)():n)[0];let i=process.env.POSTGRES_URL_NON_POOLING||process.env.DATABASE_URL||process.env.POSTGRES_URL;if(!i)throw Error("DATABASE_URL, POSTGRES_URL, or POSTGRES_URL_NON_POOLING must be set. Did you forget to provision a database?");let u=new s.Pool({connectionString:i,ssl:!!i?.includes("sslmode=require")&&{rejectUnauthorized:!1}});async function o(t,e){let a=await u.connect();try{return await a.query(t,e)}finally{a.release()}}r()}catch(t){r(t)}})}};var e=require("../../../../../webpack-runtime.js");e.C(t);var a=t=>e(e.s=t),r=e.X(0,[7787,4833],()=>a(5366));module.exports=r})();