# ✅ Живая активность на главной странице исправлена

## Проблема
Пользователь создал инвестицию на $101 в план "Стартер", но она не отображалась в разделе живой активности на главной странице.

## Причина
1. **Отсутствие связи investment_id**: При создании инвестиций в таблице `transactions` не заполнялось поле `investment_id`, которое связывает транзакцию с конкретной инвестицией.

2. **Неправильный SQL-запрос**: API `/api/user-activity` пытался найти план инвестиции через сложное сравнение времени создания, вместо использования прямой связи через `investment_id`.

## Исправления

### 1. Обновлен API создания инвестиций
**Файл**: `app/api/investments/create/route.ts`

```typescript
// Создаем транзакцию с investment_id
await query(
  `INSERT INTO transactions (id, user_id, investment_id, type, amount, status, description, created_at)
   VALUES (gen_random_uuid(), $1, $2, $3, $4, $5, $6, NOW())`,
  [userId, investmentResult.rows[0].id, 'investment', amountNum, 'completed', `Инвестиция в план "${plan.name}"`]
)
```

### 2. Исправлен API пользовательской активности
**Файл**: `app/api/user-activity/route.ts`

```typescript
CASE 
  WHEN t.type = 'investment' AND t.investment_id IS NOT NULL THEN 
    (SELECT p.name FROM investment_plans p 
     JOIN investments i ON i.plan_id = p.id 
     WHERE i.id = t.investment_id
     LIMIT 1)
  ELSE NULL
END as plan_name
```

### 3. Исправлены существующие данные
Создан и выполнен скрипт `fix-investment-transactions.js`, который:
- Нашел все инвестиционные транзакции без `investment_id`
- Связал их с соответствующими записями в таблице `investments`
- Исправил 2 транзакции:
  - Главный Администратор: $101.00 → план "Стартер"
  - slonkyf: $100.00 → план "Стартер"

## Результат

### ✅ API работает корректно
```json
{
  "success": true,
  "data": [
    {
      "id": "804f495d-a9e2-4d79-a20f-830c196697d0",
      "user_name": "Главный Администратор",
      "type": "investment",
      "amount": 101,
      "plan_name": "Стартер",
      "status": "completed",
      "time": "2026-01-23T04:08:00.186Z"
    }
  ]
}
```

### ✅ Главная страница показывает активность
- Последняя инвестиция "Главный Администратор" $101 в план "Стартер" теперь отображается
- Показываются названия планов для всех инвестиций
- Живая лента активности работает в реальном времени

## Проверка
1. **API**: `http://213.171.31.215/api/user-activity` - возвращает 18 транзакций с планами
2. **Сайт**: `http://213.171.31.215` - отображает живую активность на главной странице
3. **База данных**: Все инвестиционные транзакции имеют корректные `investment_id`

## Статус: ✅ ИСПРАВЛЕНО
Живая активность на главной странице теперь показывает все последние инвестиции с названиями планов в реальном времени.