"use strict";(()=>{var e={};e.id=3703,e.ids=[3703],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},8678:e=>{e.exports=import("pg")},28279:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{originalPathname:()=>v,patchFetch:()=>u,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p});var n=s(73278),a=s(45002),o=s(54877),i=s(42162),l=e([i]);i=(l.then?(await l)():l)[0];let c=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/investments/create/route",pathname:"/api/investments/create",filename:"route",bundlePath:"app/api/investments/create/route"},resolvedPagePath:"C:\\Users\\x4539\\Downloads\\Invest2025-main\\Invest2025-main\\app\\api\\investments\\create\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:m}=c,v="/api/investments/create/route";function u(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:p})}r()}catch(e){r(e)}})},42162:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{POST:()=>u});var n=s(71309),a=s(64985),o=s(67390),i=s.n(o),l=e([a]);async function u(e){try{console.log("=== CREATING INVESTMENT ===");let t=function(e){let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return null;let s=t.substring(7);try{let e=process.env.NEXTAUTH_SECRET||process.env.JWT_SECRET||"fallback_secret";return i().verify(s,e)}catch(e){return console.error("Token verification error:",e),null}}(e);if(!t)return n.NextResponse.json({error:"Необходима авторизация"},{status:401});let s=await e.json();console.log("Request body:",s),console.log("Request body types:",{planId:typeof s.planId,amount:typeof s.amount});let{planId:r,amount:o}=s,l=t.userId;if(console.log("Parsed values:",{userId:l,planId:r,amount:o}),!r||!o)return console.log("Missing fields:",{planId:r,amount:o,userId:l}),n.NextResponse.json({success:!1,error:"Missing required fields: planId and amount"},{status:400});let u=parseFloat(o);if(isNaN(u)||u<=0)return n.NextResponse.json({success:!1,error:"Invalid amount"},{status:400});console.log("Creating investment:",{userId:l,planId:r,amount:u});let c=await (0,a.I)("SELECT balance FROM users WHERE id = $1",[l]);if(0===c.rows.length)return n.NextResponse.json({success:!1,error:"User not found"},{status:404});let d=parseFloat(c.rows[0].balance);if(console.log("User balance:",d),d<u)return n.NextResponse.json({success:!1,error:`Insufficient balance. Available: $${d}`},{status:400});let p=await (0,a.I)("SELECT duration, daily_percent, name FROM investment_plans WHERE id = $1",[r]);if(0===p.rows.length)return n.NextResponse.json({success:!1,error:"Plan not found"},{status:404});let m=p.rows[0];console.log("Investment plan:",m);let v=new Date;v.setDate(v.getDate()+m.duration);let E=u*m.daily_percent/100;console.log("Calculated daily profit:",E),await (0,a.I)("BEGIN");try{let e=await (0,a.I)(`INSERT INTO investments (id, user_id, plan_id, amount, daily_profit, status, start_date, end_date, created_at)
         VALUES (gen_random_uuid(), $1, $2, $3, $4, $5, NOW(), $6, NOW())
         RETURNING id`,[l,r,u,E,"active",v]);return await (0,a.I)("UPDATE users SET balance = balance - $1, total_invested = COALESCE(total_invested, 0) + $1 WHERE id = $2",[u,l]),await (0,a.I)(`INSERT INTO transactions (id, user_id, type, amount, status, description, created_at)
         VALUES (gen_random_uuid(), $1, $2, $3, $4, $5, NOW())`,[l,"investment",u,"completed",`Инвестиция в план "${m.name}"`]),await (0,a.I)("COMMIT"),console.log("✅ Investment created successfully"),n.NextResponse.json({success:!0,message:"Инвестиция создана успешно",investment:{id:e.rows[0].id,amount:u,daily_profit:E,plan:m.name,duration:m.duration,daily_return:m.daily_percent},newBalance:d-u})}catch(e){throw await (0,a.I)("ROLLBACK"),e}}catch(e){return console.error("❌ Error creating investment:",e),n.NextResponse.json({success:!1,error:"Failed to create investment",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}a=(l.then?(await l)():l)[0],r()}catch(e){r(e)}})},64985:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.d(t,{I:()=>o,d:()=>l});var n=s(8678),a=e([n]);n=(a.then?(await a)():a)[0];let i=process.env.POSTGRES_URL_NON_POOLING||process.env.DATABASE_URL||process.env.POSTGRES_URL;if(!i)throw Error("DATABASE_URL, POSTGRES_URL, or POSTGRES_URL_NON_POOLING must be set. Did you forget to provision a database?");let l=new n.Pool({connectionString:i,ssl:!!i?.includes("sslmode=require")&&{rejectUnauthorized:!1}});async function o(e,t){let s=await l.connect();try{return await s.query(e,t)}finally{s.release()}}r()}catch(e){r(e)}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[7787,4833,7390],()=>s(28279));module.exports=r})();